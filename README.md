# YuihaFS

## Enviroment

- Distribution == Ubuntu10.04
- Linux Kernel == 2.6.32

### How to create VM of Ubuntu10.04

```bash
$ virt-install --name ubunt1004 \
--ram 4096 \
--disk path=/var/lib/libvirt/images/ubuntu1004.img,size=20 \
--vcpus 2 --os-variant=ubuntu10.04 \
--network bridge=virbr0 \
--graphics none \
--console pty,target_type=serial \
--location /home/images/ubuntu-10.04-server-amd64.iso \
--extra-args 'console=ttyS0,115200n8 serial'
```

### How to initialize build enviroment

```bash
$ sudo sed -i -e 's|//.*ubuntu.com/|//old-releases.ubuntu.com/|' /etc/apt/sources.list
$ sudo apt-get update
$ sudo apt-get install -y \
		nfs-common \
		libncurses-dev \
		openssh-server
$ Download Linux kernel source code of 2.6.32
$ cd linux-2.6.32
$ make -j2
$ sudo make modules_install && \
		sudo make install && \
		sudo mkinitramfs -o /boot/initrd.img-2.6.32 2.6.32
$ sed -e "s/GRUB_DEFAULT=0/GRUB_DEFAULT=\"Ubuntu, with Linux 2.6.32\"/" /etc/default/grub | sudo tee /etc/default/grub
$ sudo update-grub
$ sudo reboot
```

## How to build

```bash
$ make
```

## How to install

```bash
$ make install
```

## How to load

```bash
$ make load
```

## How to use

```bash
$ dd if=/dev/zero of=loop1.img bs=1M count=100
$ sudo losetup /dev/loop0 loop1.img
$ sudo mke2fs -t ext3 -I 256 /dev/loop0
$ mkdir yuiha_mnt
$ sudo mount -t ext3 /dev/loop0 ./yuiha_mnt
$ sudo chown master:master ./yuiha_mnt
$ touch yuiha_mnt/hoge
$ echo fugafuga >> yuiha_mnt/hoge
$ yuiha_util --snapshot=./yuiha_mnt/hoge
$ echo mogemoge >> yuiha_mnt/hoge
```

`yuiha_util` command command repository is https://github.com/sai-lab/YuihaFS-util

### Cheik if backingstore state is correct

Block number and i-node number change depending on execution time

```bash
$ hexdump -C -v -s 270080 -n 256 loop1.img
00041f00  a4 81 e8 03 12 00 00 00  d2 fb 07 65 dc fb 07 65  |...........e...e|
00041f10  dc fb 07 65 00 00 00 00  e8 03 01 00 04 00 00 00  |...e............|
00041f20  00 00 00 00 00 00 00 00  02 0e 00 80 00 00 00 00  |................|
00041f30  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041f40  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041f50  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041f60  00 00 00 00 e1 66 9e 24  00 00 00 00 00 00 00 00  |.....f.$........|
00041f70  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041f80  04 00 00 00 0d 00 00 00  00 00 00 00 00 00 00 00  |................|
00041f90  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041fa0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041fb0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041fc0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041fd0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041fe0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00041ff0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00042000

$ hexdump -C -v -s 270336 -n 256 loop1.img
00042000  a4 81 e8 03 09 00 00 00  d2 fb 07 65 d5 fb 07 65  |...........e...e|
00042010  d5 fb 07 65 00 00 00 00  e8 03 01 00 02 00 00 00  |...e............|
00042020  00 00 00 00 00 00 00 00  01 0e 00 80 00 00 00 00  |................|
00042030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00042040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00042050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00042060  00 00 00 00 e1 66 9e 24  00 00 00 00 00 00 00 00  |.....f.$........|
00042070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00042080  04 00 00 00 00 00 00 00  00 00 00 00 0c 00 00 00  |................|
00042090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000420a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000420b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000420c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000420d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000420e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000420f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00042100

$ hexdump -C -v -s 3672064 -n 256 loop1.img
00380800  66 75 67 61 66 75 67 61  0a 6d 6f 67 65 6d 6f 67  |fugafuga.mogemog|
00380810  65 0a 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |e...............|
00380820  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380840  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380860  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380870  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380880  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380890  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003808a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003808b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003808c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003808d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003808e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003808f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380900

$ hexdump -C -v -s 3671040 -n 256 loop1.img
00380400  66 75 67 61 66 75 67 61  0a 00 00 00 00 00 00 00  |fugafuga........|
00380410  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380420  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380430  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380440  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380450  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380460  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380470  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380480  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380490  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003804a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003804b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003804c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003804d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003804e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
003804f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00380500
```

